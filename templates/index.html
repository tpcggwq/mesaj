<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mesajlaşma Sistemi - Kullanıcı Adı ile</title>
<style>
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif; background: #050a15; color: #0ff;
  }
  #login-container, #chat-container {
    max-width: 400px;
    margin: 40px auto;
    background: #111f3d;
    padding: 20px;
    border-radius: 10px;
  }
  input, button, textarea {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background: #0ff;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #0cc;
  }
  #chat-area {
    border: 1px solid #0ff;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #001122;
    margin-bottom: 10px;
  }
  .message {
    margin-bottom: 15px;
    border-bottom: 1px dotted #0ff;
    padding-bottom: 10px;
  }
  .message img {
    max-width: 100%;
    border-radius: 8px;
    display: block;
    margin-top: 5px;
  }
  #friend-username {
    margin-top: 20px;
  }
  #friends-list {
    margin-top: 20px;
  }
  #friends-list div {
    padding: 8px;
    border-bottom: 1px solid #0ff4;
    cursor: pointer;
  }
  #friends-list div:hover {
    background: #0ff2;
    color: #000;
  }
  .remember-container {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .remember-container label {
    user-select: none;
  }
</style>
</head>
<body>

<div id="login-container">
  <h2>Giriş Yap / Kayıt Ol</h2>
  <input type="text" id="username" placeholder="Kullanıcı Adı" />
  <input type="email" id="email" placeholder="E-posta (sadece kayıt için)" />
  <input type="password" id="password" placeholder="Şifre" />
  <div class="remember-container">
    <input type="checkbox" id="remember-me" />
    <label for="remember-me">Beni Hatırla</label>
  </div>
  <button id="login-btn">Giriş Yap</button>
  <button id="register-btn">Kayıt Ol</button>
</div>

<div id="chat-container" style="display:none;">
  <h2>Mesajlaşma</h2>
  <div>
    <b>Hoşgeldin, <span id="user-name"></span>!</b>
    <button id="logout-btn" style="float:right; width:auto; padding:5px 10px; background:#f00; color:#fff; border:none; border-radius:5px;">Çıkış</button>
  </div>
  
  <input type="text" id="friend-username" placeholder="Arkadaşının kullanıcı adını yaz ve seç" />
  <button id="add-friend-btn">Arkadaş Ekle</button>
  <div id="friends-list"></div>
  
  <div id="chat-area"></div>
  
  <input type="text" id="note-input" placeholder="Fotoğraf altına not yaz..." />
  <input type="file" id="photo-input" accept="image/*" />
  <button id="send-msg-btn">Gönder</button>
</div>

<script>
  // Elemanlar
  const loginContainer = document.getElementById('login-container');
  const chatContainer = document.getElementById('chat-container');
  const usernameInput = document.getElementById('username');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const rememberCheckbox = document.getElementById('remember-me');
  const loginBtn = document.getElementById('login-btn');
  const registerBtn = document.getElementById('register-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userNameSpan = document.getElementById('user-name');
  const friendUsernameInput = document.getElementById('friend-username');
  const addFriendBtn = document.getElementById('add-friend-btn');
  const friendsListDiv = document.getElementById('friends-list');
  const chatArea = document.getElementById('chat-area');
  const noteInput = document.getElementById('note-input');
  const photoInput = document.getElementById('photo-input');
  const sendMsgBtn = document.getElementById('send-msg-btn');

  let currentUser = null;
  let currentFriend = null;
  let friends = [];

  // Sayfa yüklendiğinde giriş bilgisi kontrolü (beni hatırla)
  window.onload = () => {
    const rememberedUser = localStorage.getItem('rememberedUser');
    if (rememberedUser) {
      currentUser = rememberedUser;
      showChat();
    }
  };

  // Kayıt fonksiyonu
  registerBtn.onclick = () => {
    const username = usernameInput.value.trim().toLowerCase();
    const email = emailInput.value.trim().toLowerCase();
    const password = passwordInput.value;

    if (!username || !email || !password) {
      alert('Lütfen tüm alanları doldurun!');
      return;
    }

    if (localStorage.getItem('user_' + username)) {
      alert('Bu kullanıcı adı zaten kayıtlı!');
      return;
    }

    if (password.length < 6) {
      alert('Şifre en az 6 karakter olmalı!');
      return;
    }

    const newUser = {
      email,
      password,
      friends: [],
      messages: {}
    };

    localStorage.setItem('user_' + username, JSON.stringify(newUser));
    alert('Kayıt başarılı! Giriş yapabilirsiniz.');
    // Kayıt sonrası otomatik giriş
    currentUser = username;
    if (rememberCheckbox.checked) {
      localStorage.setItem('rememberedUser', currentUser);
    }
    showChat();
  };

  // Giriş fonksiyonu
  loginBtn.onclick = () => {
    const username = usernameInput.value.trim().toLowerCase();
    const password = passwordInput.value;

    if (!username || !password) {
      alert('Lütfen tüm alanları doldurun!');
      return;
    }

    const userStr = localStorage.getItem('user_' + username);
    if (!userStr) {
      alert('Böyle bir kullanıcı bulunamadı!');
      return;
    }
    const user = JSON.parse(userStr);
    if (user.password !== password) {
      alert('Şifre yanlış!');
      return;
    }

    currentUser = username;
    if (rememberCheckbox.checked) {
      localStorage.setItem('rememberedUser', currentUser);
    } else {
      localStorage.removeItem('rememberedUser');
    }
    showChat();
  };

  // Chat arayüzünü göster
  function showChat() {
    loginContainer.style.display = 'none';
    chatContainer.style.display = 'block';
    userNameSpan.textContent = currentUser;

    // Kullanıcının arkadaşlarını yükle
    const userData = JSON.parse(localStorage.getItem('user_' + currentUser));
    friends = userData.friends || [];
    renderFriends();

    // Mesaj alanını temizle
    chatArea.innerHTML = '';
    currentFriend = null;
  }

  // Çıkış yap
  logoutBtn.onclick = () => {
    currentUser = null;
    currentFriend = null;
    friends = [];
    loginContainer.style.display = 'block';
    chatContainer.style.display = 'none';
    localStorage.removeItem('rememberedUser');

    // Giriş alanlarını temizle
    usernameInput.value = '';
    emailInput.value = '';
    passwordInput.value = '';
    rememberCheckbox.checked = false;
  };

  // Arkadaş ekleme
  addFriendBtn.onclick = () => {
    const friendName = friendUsernameInput.value.trim().toLowerCase();
    if (!friendName) {
      alert('Lütfen bir kullanıcı adı yazın!');
      return;
    }
    if (friendName === currentUser) {
      alert('Kendinizi arkadaş olarak ekleyemezsiniz!');
      return;
    }
    if (friends.includes(friendName)) {
      alert('Bu kullanıcı zaten arkadaş listenizde!');
      return;
    }
    const friendDataStr = localStorage.getItem('user_' + friendName);
    if (!friendDataStr) {
      alert('Böyle bir kullanıcı bulunamadı!');
      return;
    }

    friends.push(friendName);
    // Kullanıcı verisini güncelle
    const userData = JSON.parse(localStorage.getItem('user_' + currentUser));
    userData.friends = friends;
    localStorage.setItem('user_' + currentUser, JSON.stringify(userData));

    friendUsernameInput.value = '';
    renderFriends();
    alert(friendName + ' arkadaş listenize eklendi!');
  };

  // Arkadaş listesini göster
  function renderFriends() {
    friendsListDiv.innerHTML = '';
    if (friends.length === 0) {
      friendsListDiv.innerHTML = '<p>Henüz arkadaşınız yok.</p>';
      return;
    }
    friends.forEach(friend => {
      const div = document.createElement('div');
      div.textContent = friend;
      div.onclick = () => {
        currentFriend = friend;
        loadMessages();
      };
      friendsListDiv.appendChild(div);
    });
  }

  // Mesajları yükle
  function loadMessages() {
    chatArea.innerHTML = '';
    const userData = JSON.parse(localStorage.getItem('user_' + currentUser));
    if (!userData.messages) return;
    const msgs = userData.messages[currentFriend] || [];
    msgs.forEach(msg => {
      addMessageToChat(msg.note, msg.photoDataUrl, 'friend');
    });
  }

  // Mesaj gönder
  sendMsgBtn.onclick = () => {
    if (!currentFriend) {
      alert('Lütfen önce bir arkadaş seçin!');
      return;
    }

    const note = noteInput.value.trim();
    if (!note && photoInput.files.length === 0) {
      alert('Lütfen bir not yazın veya fotoğraf seçin!');
      return;
    }

    const file = photoInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        saveMessage(note, e.target.result);
      };
      reader.readAsDataURL(file);
    } else {
      saveMessage(note, null);
    }
  };

  // Mesaj kaydet
  function saveMessage(note, photoDataUrl) {
    let userData = JSON.parse(localStorage.getItem('user_' + currentUser));
    if (!userData.messages) userData.messages = {};
    if (!userData.messages[currentFriend]) userData.messages[currentFriend] = [];

    userData.messages[currentFriend].push({ note, photoDataUrl });
    localStorage.setItem('user_' + currentUser, JSON.stringify(userData));

    addMessageToChat(note, photoDataUrl, 'me');
    noteInput.value = '';
    photoInput.value = '';
  }

  // Chat alanına mesaj ekleme fonksiyonu
  function addMessageToChat(note, photoDataUrl, sender = 'me') {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');
    msgDiv.style.textAlign = sender === 'me' ? 'right' : 'left';

    const noteP = document.createElement('p');
    noteP.textContent = note;
    msgDiv.appendChild(noteP);

    if (photoDataUrl) {
      const img = document.createElement('img');
      img.src = photoDataUrl;
      msgDiv.appendChild(img);
    }

    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  }
</script>

</body>
</html>
