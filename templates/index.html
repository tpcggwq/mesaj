<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mesajlaşma Sistemi - Firebase Entegrasyonlu</title>

<style>
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif; background: #050a15; color: #0ff;
  }
  #login-container, #chat-container {
    max-width: 400px;
    margin: 40px auto;
    background: #111f3d;
    padding: 20px;
    border-radius: 10px;
  }
  input, button, textarea {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background: #0ff;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #0cc;
  }
  #chat-area {
    border: 1px solid #0ff;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #001122;
    margin-bottom: 10px;
  }
  .message {
    margin-bottom: 15px;
    border-bottom: 1px dotted #0ff;
    padding-bottom: 10px;
  }
  .message img {
    max-width: 100%;
    border-radius: 8px;
    display: block;
    margin-top: 5px;
  }
  #friends-list {
    margin-top: 20px;
  }
  #friends-list div {
    padding: 8px;
    border-bottom: 1px solid #0ff4;
    cursor: pointer;
  }
  #friends-list div:hover {
    background: #0ff2;
    color: #000;
  }
  #remember-me-container {
    display: flex;
    align-items: center;
    margin-top: 10px;
  }
  #remember-me-container input[type="checkbox"] {
    margin-right: 8px;
  }
</style>

<!-- Firebase SDK'ları -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>

<div id="login-container">
  <h2>Giriş Yap / Kayıt Ol</h2>
  <input type="text" id="username" placeholder="Kullanıcı Adı" autocomplete="username" />
  <input type="email" id="email" placeholder="E-posta (sadece kayıt için)" autocomplete="email" />
  <input type="password" id="password" placeholder="Şifre" autocomplete="current-password" />
  <div id="remember-me-container">
    <input type="checkbox" id="remember-me" />
    <label for="remember-me">Beni hatırla</label>
  </div>
  <button id="login-btn">Giriş Yap</button>
  <button id="register-btn">Kayıt Ol</button>
</div>

<div id="chat-container" style="display:none;">
  <h2>Mesajlaşma</h2>
  <div>
    <b>Hoşgeldin, <span id="user-name"></span>!</b>
    <button id="logout-btn" style="float:right; width:auto; padding:5px 10px; background:#f00; color:#fff; border:none; border-radius:5px;">Çıkış</button>
  </div>
  
  <input type="text" id="friend-username" placeholder="Arkadaşının kullanıcı adını yaz ve ekle" />
  <button id="add-friend-btn">Arkadaş Ekle</button>
  <div id="friends-list"></div>
  
  <div id="chat-area"></div>
  
  <input type="text" id="note-input" placeholder="Fotoğraf altına not yaz..." />
  <input type="file" id="photo-input" accept="image/*" />
  <button id="send-msg-btn">Gönder</button>
</div>

<script>
  // Firebase yapılandırma ve başlatma
  const firebaseConfig = {
    apiKey: "AIzaSyDCnBMVNe3A9LPGbO_ZhExn5TKqWLz7WuU",
    authDomain: "mesaj-f1916.firebaseapp.com",
    projectId: "mesaj-f1916",
    storageBucket: "mesaj-f1916.firebasestorage.app",
    messagingSenderId: "536452620539",
    appId: "1:536452620539:web:82a98f87008cf0eef0505e",
    measurementId: "G-5L4D051ES5"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Buradan sonrası senin mevcut uygulama kodun (localStorage tabanlı)
  (() => {
    const loginContainer = document.getElementById('login-container');
    const chatContainer = document.getElementById('chat-container');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userNameSpan = document.getElementById('user-name');

    const friendUsernameInput = document.getElementById('friend-username');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const friendsListDiv = document.getElementById('friends-list');

    const chatArea = document.getElementById('chat-area');
    const noteInput = document.getElementById('note-input');
    const photoInput = document.getElementById('photo-input');
    const sendMsgBtn = document.getElementById('send-msg-btn');

    // Kullanıcı verileri storage keyleri
    const STORAGE_USERS_KEY = 'users';
    const STORAGE_LOGGEDIN_KEY = 'loggedInUser'; // obj: {username,email,rememberMe}
    const STORAGE_MESSAGES_KEY = 'messages'; // {from,to, note, photoDataUrl, timestamp}

    function getUsers() {
      return JSON.parse(localStorage.getItem(STORAGE_USERS_KEY) || '{}');
    }
    function saveUsers(users) {
      localStorage.setItem(STORAGE_USERS_KEY, JSON.stringify(users));
    }

    function getMessages() {
      return JSON.parse(localStorage.getItem(STORAGE_MESSAGES_KEY) || '[]');
    }
    function saveMessages(messages) {
      localStorage.setItem(STORAGE_MESSAGES_KEY, JSON.stringify(messages));
    }

    function getLoggedInUser() {
      return JSON.parse(localStorage.getItem(STORAGE_LOGGEDIN_KEY) || 'null');
    }
    function setLoggedInUser(userObj) {
      if(userObj) {
        if(userObj.rememberMe) {
          localStorage.setItem(STORAGE_LOGGEDIN_KEY, JSON.stringify(userObj));
        } else {
          sessionStorage.setItem(STORAGE_LOGGEDIN_KEY, JSON.stringify(userObj));
          localStorage.removeItem(STORAGE_LOGGEDIN_KEY);
        }
      } else {
        localStorage.removeItem(STORAGE_LOGGEDIN_KEY);
        sessionStorage.removeItem(STORAGE_LOGGEDIN_KEY);
      }
    }

    function autoLogin() {
      let user = getLoggedInUser();
      if(!user) {
        user = JSON.parse(sessionStorage.getItem(STORAGE_LOGGEDIN_KEY) || 'null');
        if(user) {
          localStorage.setItem(STORAGE_LOGGEDIN_KEY, JSON.stringify(user));
        }
      }
      if(user) {
        showChat(user);
      } else {
        showLogin();
      }
    }

    function showLogin() {
      loginContainer.style.display = 'block';
      chatContainer.style.display = 'none';
      usernameInput.value = '';
      emailInput.value = '';
      passwordInput.value = '';
      rememberMeCheckbox.checked = false;
    }

    function showChat(user) {
      loginContainer.style.display = 'none';
      chatContainer.style.display = 'block';
      userNameSpan.textContent = user.username;
      renderFriends(user);
      renderMessages(user.username, null);
    }

    registerBtn.onclick = () => {
      const username = usernameInput.value.trim().toLowerCase();
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      if (!username || !email || !password) {
        alert('Lütfen tüm alanları doldurun!');
        return;
      }

      if (password.length < 6) {
        alert('Şifre en az 6 karakter olmalı!');
        return;
      }

      const users = getUsers();

      if (users[username]) {
        alert('Bu kullanıcı adı zaten kayıtlı!');
        return;
      }

      users[username] = {
        email,
        password,
        friends: []
      };
      saveUsers(users);

      alert('Kayıt başarılı! Giriş yapabilirsiniz.');

      const rememberMe = rememberMeCheckbox.checked;
      setLoggedInUser({ username, email, rememberMe });
      showChat({ username, email, rememberMe });
    };

    loginBtn.onclick = () => {
      const username = usernameInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      if (!username || !password) {
        alert('Lütfen kullanıcı adı ve şifre girin!');
        return;
      }

      const users = getUsers();
      const user = users[username];
      if (!user) {
        alert('Böyle bir kullanıcı bulunamadı!');
        return;
      }
      if (user.password !== password) {
        alert('Şifre yanlış!');
        return;
      }

      const rememberMe = rememberMeCheckbox.checked;
      setLoggedInUser({ username, email: user.email, rememberMe });
      showChat({ username, email: user.email, rememberMe });
    };

    logoutBtn.onclick = () => {
      setLoggedInUser(null);
      showLogin();
    };

    addFriendBtn.onclick = () => {
      const friendUsername = friendUsernameInput.value.trim().toLowerCase();
      if(!friendUsername) {
        alert('Lütfen bir kullanıcı adı yazın.');
        return;
      }

      const loggedInUser = getLoggedInUser();
      if(!loggedInUser) {
        alert('Lütfen önce giriş yapın!');
        showLogin();
        return;
      }

      if(friendUsername === loggedInUser.username) {
        alert('Kendinizi arkadaş olarak ekleyemezsiniz.');
        return;
      }

      const users = getUsers();
      if(!users[friendUsername]) {
        alert('Böyle bir kullanıcı yok.');
        return;
      }

      if(!users[loggedInUser.username].friends.includes(friendUsername)) {
        users[loggedInUser.username].friends.push(friendUsername);
      }
      if(!users[friendUsername].friends.includes(loggedInUser.username)) {
        users[friendUsername].friends.push(loggedInUser.username);
      }
      saveUsers(users);

      alert(friendUsername + ' arkadaş olarak eklendi.');
      renderFriends(loggedInUser);
      friendUsernameInput.value = '';
    };

    function renderFriends(user) {
      const users = getUsers();
      const userData = users[user.username];
      if(!userData || !userData.friends) {
        friendsListDiv.innerHTML = '<i>Arkadaşınız yok.</i>';
        return;
      }
      friendsListDiv.innerHTML = '';
      userData.friends.forEach(friend => {
        const div = document.createElement('div');
        div.textContent = friend;
        div.onclick = () => {
          renderMessages(user.username, friend);
        };
        friendsListDiv.appendChild(div);
      });
    }

    let currentChatFriend = null;

    function renderMessages(myUsername, friendUsername) {
      currentChatFriend = friendUsername;
      chatArea.innerHTML = '';
      if(!friendUsername) {
        chatArea.innerHTML = '<i>Bir arkadaş seçin ya da mesaj gönderin.</i>';
        return;
      }
      const messages = getMessages();
      const filtered = messages.filter(m =>
        (m.from === myUsername && m.to === friendUsername) ||
        (m.from === friendUsername && m.to === myUsername)
      );

      filtered.sort((a,b) => a.timestamp - b.timestamp);

      filtered.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<b>${msg.from}:</b> ${msg.note || ''}`;
        if(msg.photoDataUrl){
          const img = document.createElement('img');
          img.src = msg.photoDataUrl;
          div.appendChild(img);
        }
        chatArea.appendChild(div);
      });
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    sendMsgBtn.onclick = () => {
      const loggedInUser = getLoggedInUser();
      if(!loggedInUser) {
        alert('Lütfen önce giriş yapın!');
        showLogin();
        return;
      }
      if(!currentChatFriend) {
        alert('Lütfen mesaj göndermek için bir arkadaş seçin.');
        return;
      }

      const note = noteInput.value.trim();
      const photoFile = photoInput.files[0];

      if(!note && !photoFile) {
        alert('En az bir not veya fotoğraf eklemelisiniz.');
        return;
      }

      if(photoFile){
        const reader = new FileReader();
        reader.onload = function(e){
          const photoDataUrl = e.target.result;
          saveMessage(loggedInUser.username, currentChatFriend, note, photoDataUrl);
          noteInput.value = '';
          photoInput.value = '';
          renderMessages(loggedInUser.username, currentChatFriend);
        };
        reader.readAsDataURL(photoFile);
      } else {
        saveMessage(loggedInUser.username, currentChatFriend, note, null);
        noteInput.value = '';
        renderMessages(loggedInUser.username, currentChatFriend);
      }
    };

    function saveMessage(from, to, note, photoDataUrl){
      const messages = getMessages();
      messages.push({
        from,
        to,
        note,
        photoDataUrl,
        timestamp: Date.now()
      });
      saveMessages(messages);
    }

    // Sayfa yüklendiğinde otomatik giriş yap veya login göster
    autoLogin();

  })();
</script>

</body>
</html>
